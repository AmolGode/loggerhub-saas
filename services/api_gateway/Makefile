# ===============
#  Django Service Makefile (Reusable)
#  Works inside Docker container context.

#  Usage:
#     make install pkg=<package>
#     make freeze
#     make rebuild
#     make migrate

# ===============

COMPOSE_FILE := ../../infra/docker-compose.yml
svc ?= api_gateway

# Install a package and sync requirements
install:
	@echo "ğŸ“¦ Installing $(pkg) into $(svc)..."
	docker compose -f $(COMPOSE_FILE) exec $(svc) pip install $(pkg)
	docker compose -f $(COMPOSE_FILE) exec $(svc) sh -c "pip freeze > requirements.txt"
	@echo "âœ… Installed and synced requirements.txt for $(svc)"

# Freeze dependencies to requirements.txt
freeze:
	@echo "â„ï¸ Freezing dependencies for $(svc)..."
	docker compose -f $(COMPOSE_FILE) exec $(svc) sh -c "pip freeze > requirements.txt"
	@echo "âœ… requirements.txt updated for $(svc)"

# Run migrations
migrate:
	@echo "ğŸ§© Running migrations for $(svc)..."
	docker compose -f $(COMPOSE_FILE) exec $(svc) python manage.py migrate
	@echo "âœ… Migrations complete."

# Open Django shell
shell:
	@echo "ğŸš Opening Django shell for $(svc)..."
	docker compose -f $(COMPOSE_FILE) exec $(svc) python manage.py shell

# Collect static files
collectstatic:
	@echo "ğŸ§¹ Collecting static files for $(svc)..."
	docker compose -f $(COMPOSE_FILE) exec $(svc) python manage.py collectstatic --noinput
	@echo "âœ… Static files collected."

# Restart only this service
restart:
	docker compose -f $(COMPOSE_FILE) restart $(svc)
	@echo "ğŸ”„ Restarted $(svc)."
